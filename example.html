<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Verse Demo</title>
    <style type="text/css">
#terminal {
  font-family: monospace;
  white-space: pre;
}
    </style>
  </head>
  <body>
    <div id="terminal"></div>
    <script type="text/javascript" src=".build-tmp/verse.js"></script>
    <script>
let app

/* DOM STUFF */

document.body.addEventListener('keydown', event => {
  if (event.key === 'Escape') {
    app.interrupt()
  } else {
    app.receiveKeydown(event)
  }
})

function view(state) {
  terminal.innerText = last(30, state.logs).join('\n')
  if (state.cursor) {
    terminal.innerText += state.cursor
  }
}

/* MAIN */

function main() {
  app = App(window)
}

/* STATE */

function getStateType() {
  return {
    logs: isArrayOf(isString),
    cursor: isString
  }
}

/* SAGAS */

function *init() {
  yield GuessingGame
}

function *GuessingGame(tell) {
  let secret = Math.ceil(Math.random() * 100)
  tell(log("I'm thinking of a number between 1 and 100"))
  yield function*() {
    let number = yield GetNumber
    if (number > secret) {
      tell(log(number + ' is too high!'))
      yield retry()
    } else if (number < secret) {
      tell(log(number + ' is too low!'))
      yield retry()
    } else {
      tell(log('You got it!'))
    }
  }
}

function *GetNumber(tell) {
  let line = yield waitForLine()
  if (isNaN(line)) {
    tell(log("That's not a number. Try again."))
    yield retry()
  }
  return +line
}

/* EFFECTS */

function waitForLine() {
  return function*(tell) {
    let result = '', a
    let cursor = '_'
    tell(setCursor(cursor))
    yield startTimer(0.4, () => {
      cursor = cursor ? '' : '_'
      tell(setCursor(cursor))
    })

    tell(log('>'))
    yield function*() {
      let c = yield waitForChar()
      if (c === SIGNAL_INTERRUPTED) return
      if (c !== 'Enter') {
        result += c
        tell(replaceLastLog('> ' + result))
        yield retry()
      }
    }
    tell(setCursor(''))
    return result
  }
}

/* REDUCERS */

function reducer(state, action) {
  return reduceByDelegates(state, action, {
    logs: logsReducer,
    cursor: cursorReducer
  })
}

function logsReducer(logs, action) {
  switch (action.type) {
    case 'LOG':
    return [...logs, action.params]

    case 'REPLACE_LAST_LOG':
    return [...dropLast(1, logs), action.params]
  }
  return logs
}

function cursorReducer(cursor, action) {
  switch (action.type) {
    case 'SET_CURSOR':
    return action.params
  }
  return cursor
}

/* ACTIONS */

function log(string) {
  return {
    type: 'LOG',
    params: string
  }
}

function replaceLastLog(string) {
  return {
    type: 'REPLACE_LAST_LOG',
    params: string
  }
}

function setCursor(string) {
  return {
    type: 'SET_CURSOR',
    params: string
  }
}

/* LIBRARY */

function last(n, array) {
  if (n > array.length) return array
  return array.slice(array.length - n)
}

function dropLast(n, array) {
  if (n > array.length) return []
  return array.slice(0, array.length - n)
}

function reduceByDelegates(state, action, reducerMap) {
  let result = {}
  for (let key in reducerMap) {
    if (has(key, reducerMap)) {
      result[key] = reducerMap[key](state[key], action)
    }
  }
  return result
}

main()
    </script>
  </body>
</html>
